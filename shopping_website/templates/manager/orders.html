{% extends "base.html" %}
{% block title %}訂單總覽{% endblock %}

{% block content %}
<h2 class="page-title">訂單總覽</h2>
<p class="text-muted">
  管理者查看所有訂單（可搜尋、可依製程狀態篩選）。
  搜尋欄可輸入：訂單ID / 客戶 / 產品 / 備註 / ID(rowid)。
  <b>點訂單ID可直接進入模擬頁。</b>
</p>

<form method="get">
  <div class="grid-2">
    <div>
      <label>搜尋（訂單ID / 客戶 / 產品 / 備註 / ID）</label>
      <input type="text" name="q" value="{{ q }}" placeholder="例如：3 / 20251217... / test_1 / Fuse / 急件">
    </div>

    <div>
      <label>狀態（step_name）</label>
      <select name="step">
        <option value="">全部</option>
        {% for s in steps %}
          <option value="{{ s }}" {% if step == s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <!-- ✅ 顯示狀態篩選 -->
  <div class="mt-2" style="display:flex; gap:18px; flex-wrap:wrap;">
    <label style="display:flex; align-items:center; gap:8px;">
      <input type="checkbox" name="show_rejected" value="1" {% if show_rejected %}checked{% endif %}>
      顯示已拒絕（rejected）
    </label>

    <label style="display:flex; align-items:center; gap:8px;">
      <input type="checkbox" name="show_cancelled" value="1" {% if show_cancelled %}checked{% endif %}>
      顯示客戶取消（cancelled）
    </label>

    <label style="display:flex; align-items:center; gap:8px;">
      <input type="checkbox" name="show_completed" value="1" {% if show_completed %}checked{% endif %}>
      顯示已完成（completed）
    </label>
  </div>

  <div class="mt-2 text-right">
    <button type="submit">查詢</button>
    <a class="btn btn-secondary" href="{{ url_for('manager.manager_orders') }}">清除</a>
  </div>
</form>

<div class="table-wrap">
  <table class="table-orders">
    <thead>
      <tr>
        <th>ID</th>
        <th>訂單ID（點我進模擬）</th>
        <th>時間</th>
        <th>客戶</th>
        <th>產品</th>
        <th>數量</th>
        <th>總價</th>
        <th>製程狀態</th>
        <th>狀態</th>
        <th>備註</th>
        <th>操作</th>
      </tr>
    </thead>

    <tbody>
      {% if orders and orders|length > 0 %}
        {% for o in orders %}
          {% set st = o["status"] %}
          {% set is_rejected = (st == "rejected") %}
          {% set is_cancelled = (st == "cancelled") %}
          {% set is_completed = (st == "completed") %}

          <tr class="{% if is_rejected %}row-rejected{% endif %} {% if is_cancelled %}row-cancelled{% endif %} {% if is_completed %}row-completed{% endif %}">
            <td>{{ o["id"] }}</td>

            <td class="mono">
              <!-- ✅ 點訂單ID直接進入模擬頁 -->
              <a href="{{ url_for('factory.simulate', order_id=o['order_id']) }}" title="進入製程模擬">
                {{ o["order_id"] }}
              </a>
              <!-- 保留詳情 -->
              <div style="margin-top:4px; font-size:12px;">
                <a class="text-muted" href="{{ url_for('manager.manager_order_detail', order_id=o['order_id']) }}">查看詳情</a>
              </div>
            </td>

            <td>{{ o["date"] }}</td>
            <td>{{ o["customer_name"] }}</td>
            <td class="cell-wrap">{{ o["product"] }}</td>
            <td>{{ o["amount"] }}</td>
            <td>{{ o["total_price"] }}</td>
            <td class="cell-wrap">{{ o["step_name"] }}</td>

            <td>
              {% if is_rejected %}
                <span class="badge badge-danger">rejected</span>
              {% elif is_cancelled %}
                <span class="badge badge-muted">cancelled</span>
              {% elif is_completed %}
                <span class="badge badge-info">completed</span>
              {% else %}
                <span class="badge badge-success">active</span>
              {% endif %}
            </td>

            <td class="cell-note">{{ o["note"] }}</td>

            <td>
              <!-- ✅ 只有 active 才能拒絕；cancelled/completed/rejected 都顯示 — -->
              {% if st == "active" %}
                <form method="post"
                      action="{{ url_for('manager.manager_order_delete', order_id=o['order_id']) }}"
                      data-confirm="確定要拒絕/刪單 {{ o['order_id'] }} 嗎？此操作會保留紀錄，但會標記為 rejected。">

                  <!-- 保留查詢條件 -->
                  <input type="hidden" name="q" value="{{ q }}">
                  <input type="hidden" name="step" value="{{ step }}">
                  <input type="hidden" name="show_rejected" value="{{ '1' if show_rejected else '' }}">
                  <input type="hidden" name="show_cancelled" value="{{ '1' if show_cancelled else '' }}">
                  <input type="hidden" name="show_completed" value="{{ '1' if show_completed else '' }}">

                  <select name="reason" required>
                    <option value="" disabled selected>選擇拒絕原因</option>
                    <option value="庫存不足">庫存不足</option>
                    <option value="付款狀態異常">付款狀態異常</option>
                    <option value="資料不完整（收件資訊缺漏）">資料不完整（收件資訊缺漏）</option>
                    <option value="超出工廠當日產能">超出工廠當日產能</option>
                    <option value="其他原因（請聯絡客服）">其他原因（請聯絡客服）</option>
                  </select>

                  <button type="submit" class="btn btn-danger">拒絕/刪單</button>
                </form>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="11" class="text-center text-muted">沒有符合條件的訂單</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>
{% endblock %}
