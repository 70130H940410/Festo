{% extends "base.html" %}

{% block title %}下單頁 - 智慧工廠下單系統{% endblock %}

{% block content %}
<h2>產品下單</h2>
<p class="text-muted">
  請選擇要生產的產品與數量。系統會依照零件庫存（上蓋、下蓋、保險絲、電路板）進行檢查，
  若庫存不足將無法進入下一步的製程規劃。
</p>

{% if error_message %}
  <div class="alert alert-error">
    {{ error_message }}
  </div>
{% endif %}

<form method="post" id="order-form">
  <div class="card">
    <h3>可下單產品列表</h3>
    <p class="text-muted">
      目前支援的產品將會對應到工廠中的上蓋、下蓋、保險絲與電路板組合。
      數量為 0 的項目不會被加入訂單。
    </p>

    <table>
      <thead>
        <tr>
          <th>產品名稱</th>
          <th>描述</th>
          <th>單價</th>
          <th class="text-right">欲下單數量</th>
        </tr>
      </thead>
      <tbody>
        {% if products %}
          {% for p in products %}
          <tr>
            <td>{{ p.name }}</td>
            <td>{{ p.description or '—' }}</td>
            <td>${{ "%.0f"|format(p.base_price) }}</td>
            <td class="text-right">
              <input
                type="number"
                name="qty_{{ p.id }}"
                min="0"
                value="0"
                class="qty-input"
                data-price="{{ p.base_price }}"
              >
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="4" class="text-center text-muted">
              目前尚未設定任何產品，請洽工廠管理者於後台新增。
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>

    <!-- 下方摘要區 -->
    <div class="grid-2">
      <div class="text-muted">
        <p class="mb-1"><strong>下單提醒</strong></p>
        <ul>
          <li>系統會在下一步再次檢查零件庫存是否足夠。</li>
          <li>庫存不足的商品將無法建立訂單。</li>
        </ul>
      </div>
      <div class="text-right">
        <p class="mb-1">
          <strong>總數量：</strong>
          <span id="summary-qty">0</span> 件
        </p>
        <p class="mb-2">
          <strong>預估總金額：</strong>
          $<span id="summary-total">0</span>
        </p>
        <button type="submit">下一步：製程規劃</button>
      </div>
    </div>
  </div>
</form>

<!-- 前端即時計算總數量＆金額的腳本 -->
<script>
  function updateOrderSummary() {
    const qtyInputs = document.querySelectorAll('.qty-input');
    let totalQty = 0;
    let totalPrice = 0;

    qtyInputs.forEach(function (input) {
      const qty = parseInt(input.value, 10) || 0;
      const price = parseFloat(input.getAttribute('data-price')) || 0;
      totalQty += qty;
      totalPrice += qty * price;
    });

    document.getElementById('summary-qty').textContent = totalQty;
    document.getElementById('summary-total').textContent = totalPrice.toFixed(0);
  }

  document.addEventListener('DOMContentLoaded', function () {
    const qtyInputs = document.querySelectorAll('.qty-input');
    qtyInputs.forEach(function (input) {
      input.addEventListener('input', updateOrderSummary);
    });
    // 一開始先算一次
    updateOrderSummary();
  });
</script>
{% endblock %}


