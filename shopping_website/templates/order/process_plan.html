{% extends "base.html" %}

{% block title %}製程規劃 - 智慧工廠下單系統{% endblock %}

{% block content %}
<h2>製程規劃</h2>
<p class="text-muted">
  以下是本次訂單的產品摘要與 Festo 智慧工廠中保險絲盒的標準 9 大製程流程。之後可以再擴充為可拖曳、客製每個步驟。
</p>

<!-- 訂單摘要 -->
<div class="card">
  <h3>本次下單產品摘要</h3>
  {% if order_items_summary %}
    <table>
      <thead>
        <tr>
          <th>產品名稱</th>
          <th class="text-right">數量</th>
        </tr>
      </thead>
      <tbody>
        {% for item in order_items_summary %}
        <tr>
          <td>{{ item.name }}</td>
          <td class="text-right">{{ item.quantity }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="text-muted">
      目前沒有從下單頁帶過來的產品資料，以下以示意資料顯示。
    </p>
  {% endif %}
</div>

<!-- 標準製程流程（9 大站點） -->
<div class="card">
  <h3>標準製程流程（Festo 智慧工廠 9 大站點）</h3>
  <p class="text-muted">
    預設全選，可取消不需要的步驟。
  </p>

  <table>
    <thead>
      <tr>
        <th class="text-center" style="width: 70px;">選取</th>
        <th style="width: 60px;">順序</th>
        <th style="width: 220px;">步驟名稱</th>
        <th style="width: 260px;">站點</th>
        <th>說明</th>
        <th class="text-right" style="width: 120px;">預估時間（秒）</th>
      </tr>
    </thead>
    <tbody>
      {% for step in standard_steps %}
      <tr>
        <td class="text-center">
            <!-- Checkbox 用於讓 JS 抓取 value (step_order) -->
            <input type="checkbox" class="step-checkbox" value="{{ step.step_order }}" checked 
                   style="transform: scale(1.5); cursor: pointer;">
        </td>
        <td>{{ step.step_order }}</td>
        <td>{{ step.step_name }}</td>
        <td>{{ step.station }}</td>
        <td>{{ step.description }}</td>
        <td class="text-right">{{ step.estimated_time_sec }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- 3. 操作按鈕 -->
<div class="card">
  <h3>下一步</h3>
  <div class="mt-2 text-right">
    <a class="btn btn-secondary" href="{{ url_for('order.order_page') }}">
      返回修改
    </a>
    
    <!-- 按鈕觸發 JS submitOrder() -->
    <button type="button" id="submitBtn" class="btn btn-primary btn-lg" onclick="submitOrder()">
      下訂單並前往工廠運作模擬 (Demo)
    </button>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function submitOrder() {
    const btn = document.getElementById("submitBtn");
    
    // 1. 蒐集所有被勾選的步驟 ID
    const checkboxes = document.querySelectorAll('.step-checkbox:checked');
    const selectedSteps = Array.from(checkboxes).map(cb => cb.value);

    if (selectedSteps.length === 0) {
        alert("請至少選擇一個製程步驟！");
        return;
    }

    // 2. 鎖定按鈕
    btn.disabled = true;
    btn.innerText = "處理中...";

    // 3. 使用 fetch 發送 JSON 給後端 API
    fetch("{{ url_for('order.submit_order_api') }}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            "selected_steps": selectedSteps
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 成功：跳轉到後端指定的網址
            window.location.href = data.redirect_url;
        } else {
            // 失敗：顯示錯誤訊息
            alert("下單失敗：" + data.message);
            btn.disabled = false;
            btn.innerText = "下訂單並前往工廠運作模擬 (Demo)";
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("系統發生錯誤，請稍後再試。");
        btn.disabled = false;
        btn.innerText = "下訂單並前往工廠運作模擬 (Demo)";
    });
}
</script>
{% endblock %}






