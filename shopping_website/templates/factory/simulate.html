{# templates/factory/simulate.html #}
{% extends "base.html" %}

{% block title %}工廠運作模擬 (Demo){% endblock %}

{% block content %}
<div class="page-container">

  <h1 class="page-title">工廠運作模擬 (Demo)</h1>

  <p class="text-muted" style="margin-bottom: 1rem;">
    這個頁面示意訂單在 Festo 智慧工廠（CP-Factory）中，
    托盤沿著各站點（A1 → B → C → D → E → F → G → H → A2）依序加工的流程。
    目前由後端排程器模擬，狀態會從資料庫即時更新。
  </p>

  <!-- ===== 訂單資訊 Card ===== -->
  <div class="card" style="margin-bottom: 1.25rem;">
    <div class="card-header">
      <h2 class="card-title">訂單資訊</h2>
      <p class="text-muted" style="margin-top: .25rem;">
        已從資料庫讀取：訂單編號／下單人／備註／狀態
      </p>
    </div>

    <div class="card-body">
      <table class="table table-striped" style="width: 100%;">
        <tbody>
          <tr>
            <th style="width: 140px;">訂單編號</th>
            <td>#{{ order_info.order_id | default(order_info.id) }}</td>
          </tr>

          <tr>
            <th>下單人</th>
            <td>{{ order_info.user_name | default("Demo User") }}</td>
          </tr>

          <tr>
            <th>備註</th>
            <td>{{ order_info.note | default("無備註") }}</td>
          </tr>

          <tr>
            <th>目前狀態</th>
            <td>
              {% set st = (order_info.status | default("in_progress")) %}
              {% if st in ["in_progress", "running", "active"] %}
                <span class="badge badge-info">產線進行中…</span>
              {% elif st in ["done", "finished", "complete", "completed"] %}
                <span class="badge badge-success">已完成</span>
              {% elif st in ["rejected", "error", "failed"] %}
                <span class="badge badge-danger">異常 / 已拒絕</span>
              {% elif st in ["cancelled", "canceled"] %}
                <span class="badge badge-secondary">已取消</span>
              {% else %}
                <span class="badge badge-secondary">{{ st }}</span>
              {% endif %}
            </td>
          </tr>

          <tr>
            <th>模擬狀態</th>
            <td>
              <span id="sim-status" class="text-muted">準備初始化…</span>
            </td>
          </tr>

        </tbody>
      </table>
    </div>
  </div>

  <!-- ===== 製程步驟進度 Card ===== -->
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">製程步驟進度</h2>
      <p class="text-muted" style="margin-top: .25rem;">
        綠色代表已完成、藍色代表目前進行中、灰色代表尚未開始。
        （括號顯示：已完成件數 / 總件數）
      </p>
    </div>

    <div class="card-body">
      <ul class="timeline">
        {% for s in steps %}
          {# state 優先，其次才吃 status；若 DB 用 ACTIVE/DONE 也可映射 #}
          {% set step_state = s.state | default(s.status) | default("pending") %}
          {% if step_state not in ["pending", "running", "finished"] %}
            {% if step_state in ["DONE", "done", "completed"] %}
              {% set step_state = "finished" %}
            {% elif step_state in ["ACTIVE", "active", "in_progress"] %}
              {% set step_state = "running" %}
            {% else %}
              {% set step_state = "pending" %}
            {% endif %}
          {% endif %}

          {# done/total：後端若沒給，也不會爆 #}
          {% set done_qty = s.done_qty | default(0) %}
          {% set total_qty = s.total_qty | default(order_info.amount | default(1)) %}

          <li class="timeline-step {{ step_state }}">
            <div style="display:flex; align-items:center; gap:.6rem; flex-wrap:wrap;">
              <strong>
                Step {{ s.step_order | default(loop.index) }}：
                {{ s.step_name }}
              </strong>

              <span class="text-muted">
                ({{ done_qty }}/{{ total_qty }})
              </span>

              {% if step_state == "finished" %}
                <span class="badge badge-success">已完成</span>
              {% elif step_state == "running" %}
                <span class="badge badge-primary">進行中…</span>
              {% else %}
                <span class="badge badge-secondary">尚未開始</span>
              {% endif %}
            </div>

            {% if s.station is defined and s.station %}
              <div class="text-muted" style="margin-top:.25rem;">
                <strong>站點：</strong>{{ s.station }}
              </div>
            {% endif %}

            {% if s.description is defined and s.description %}
              <div class="text-muted" style="margin-top:.25rem; line-height:1.5;">
                {{ s.description }}
              </div>
            {% endif %}

            {% if s.estimated_time_sec is defined and s.estimated_time_sec %}
              <div class="text-muted" style="margin-top:.25rem;">
                <strong>預估時間：</strong>{{ s.estimated_time_sec }} 秒 / 件
              </div>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>

</div>

<script>
  const ORDER_ID = "{{ order_info.order_id | default('') }}";
  const statusEl = document.getElementById("sim-status");

  async function getJson(url) {
    const res = await fetch(url, { method: "GET", cache: "no-store" });
    const text = await res.text();
    try { return JSON.parse(text); }
    catch(e) { console.log("API not JSON:", text); return null; }
  }

  async function initAndRun() {
    if (!ORDER_ID) {
      statusEl.textContent = "缺少 order_id（請用 ?order_id=... 開啟此頁）";
      return;
    }

    statusEl.textContent = "初始化中…";
    await getJson(`/factory/api/init/${ORDER_ID}`);

    statusEl.textContent = "模擬進行中（每秒推進一次）…";

    setInterval(async () => {
      const r = await getJson(`/factory/api/tick`);
      console.log("tick:", r);
      window.location.reload();
    }, 1000);
  }

  window.addEventListener("load", initAndRun);
</script>
{% endblock %}






